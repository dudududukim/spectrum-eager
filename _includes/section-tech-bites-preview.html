{% assign section = include.section %}
{% comment %} Load sections from site.section_definitions (auto-loaded from _sections/*/config.yml) {% endcomment %}
{% assign tech_sections = '' | split: '' %}
{% if site.section_definitions %}
    {% for section_pair in site.section_definitions %}
        {% assign section_key = section_pair[0] %}
        {% assign section_data = section_pair[1] %}
        {% if section_data.type == 'tech-bites-preview' and section_data.enabled != false %}
            {% assign tech_sections = tech_sections | push: section_data %}
        {% endif %}
    {% endfor %}
{% endif %}
{% assign nav_tabs = tech_sections %}
{% if nav_tabs %}
    {% assign tabs_json = nav_tabs | jsonify %}
    {% assign tabs_count = nav_tabs | size %}
    {% assign default_tab = nav_tabs | first %}
{% else %}
    {% assign tabs_json = "[]" %}
    {% assign tabs_count = 0 %}
{% endif %}
{% unless default_tab %}
    {% assign default_tab = {} %}
{% endunless %}
{% assign base_label = section.button_text | default: default_tab.button_text | default: site.content.ui.buttons.view_all_tech_bites | default: "View All Tech Bites" %}
{% assign cta_url = section.button_url | default: default_tab.button_url | default: '/tech-bites/' %}
{% assign show_nav = tabs_count > 1 %}

<section class="tech-bites-preview">
    <div
        class="section-header section-header-slider"
        data-tabs="{{ tabs_json | escape }}"
        data-baseurl="{{ '' | relative_url }}"
        data-default-label="{{ base_label }}"
    >
        {% if show_nav %}
            <button class="section-nav-btn section-nav-prev" type="button" aria-label="Previous section">‹</button>
        {% endif %}
        <div class="section-header-text">
            <h2 class="section-title" id="section-tab-title">
                {{ section.title | default: "Recent Tech Bites" }}
            </h2>
            <p class="section-description" id="section-tab-desc">
                {{ section.description | default: "Daily tech insights and discoveries" }}
            </p>
        </div>
        {% if show_nav %}
            <button class="section-nav-btn section-nav-next" type="button" aria-label="Next section">›</button>
        {% endif %}
    </div>

    <div class="tech-bites-grid">
        {% if site.section_definitions and site.section_definitions.size > 0 %}
            {% assign section_key = section.key | default: "tech-bites" %}
            {% assign all_posts = site.posts | where: "section", section_key | sort: 'date' | reverse %}
            {% assign post_limit = section.main_page_count | default: 5 %}
            {% if all_posts.size > 0 %}
                {% for tech_bite in all_posts limit: post_limit %}
                    {% include tech-bite-card.html tech_bite=tech_bite %}
                {% endfor %}
            {% else %}
                <p class="empty-section-message">No posts yet. Add posts to <code>_posts/</code> folder with <code>section: "{{ section_key }}"</code> in front matter.</p>
            {% endif %}
        {% else %}
            <div class="empty-section-message">
                <p>No sections configured yet. Create <code>_sections/</code> folder and add section config files.</p>
                <p>Example: Create <code>_sections/tech-bites/config.yml</code> with section settings.</p>
            </div>
        {% endif %}
    </div>

    {% comment %} Only show button if sections are configured {% endcomment %}
    {% if site.section_definitions and site.section_definitions.size > 0 %}
        <div class="section-footer">
            <a href="{{ cta_url | relative_url }}" class="section-button">
                <span class="btn-label">{{ base_label }}</span>
                <span class="btn-icon">→</span>
            </a>
        </div>
    {% endif %}

    <div class="section-tab-placeholder" id="section-tab-placeholder" hidden>
        <p id="section-tab-placeholder-text" class="section-description"></p>
    </div>
    
    <div class="section-empty-message" id="section-empty-message" hidden>
        <p class="empty-section-message">No posts yet. Add posts to <code>_posts/</code> folder with <code>section: "<span id="section-empty-key"></span>"</code> in front matter.</p>
    </div>

    <script>
      (function() {
        const header = document.querySelector('.section-header-slider');
        if (!header) return;

        let tabs;
        try {
          tabs = JSON.parse(header.dataset.tabs || '[]');
        } catch (e) {
          tabs = [];
        }
        if (!Array.isArray(tabs) || tabs.length === 0) return;

        const titleEl = document.getElementById('section-tab-title');
        const descEl = document.getElementById('section-tab-desc');
        const grid = document.querySelector('.tech-bites-grid');
        const placeholder = document.getElementById('section-tab-placeholder');
        const placeholderText = document.getElementById('section-tab-placeholder-text');
        const emptyMessage = document.getElementById('section-empty-message');
        const emptyKey = document.getElementById('section-empty-key');
        const prevBtn = header.querySelector('.section-nav-prev');
        const nextBtn = header.querySelector('.section-nav-next');
        const actionBtn = document.querySelector('.section-footer .section-button');
        const actionBtnLabel = actionBtn?.querySelector('.btn-label');
        const baseUrl = (header.dataset.baseurl || '').replace(/\/$/, '');
        const defaultLabel = header.dataset.defaultLabel || '';
        
        {% comment %} Get post counts for each section {% endcomment %}
        const postCounts = {};
        {% if site.section_definitions %}
            {% for section_pair in site.section_definitions %}
                {% assign section_key = section_pair[0] %}
                {% assign section_posts = site.posts | where: "section", section_key %}
                postCounts['{{ section_key }}'] = {{ section_posts.size }};
            {% endfor %}
        {% endif %}

        let idx = 0;

        function resolveUrl(url) {
          if (!url) return '#';
          if (url.startsWith('http') || url.startsWith('#')) return url;
          if (url.startsWith('/')) return `${baseUrl}${url}`;
          return url;
        }

        function buildButtonClass(key) {
          const safeKey = key ? key.replace(/[^a-z0-9_-]/gi, '').toLowerCase() : 'default';
          return `section-button section-button--${safeKey}`;
        }

        function render() {
          const tab = tabs[idx];
          if (!tab || !titleEl || !descEl) return;
          titleEl.textContent = tab.title || '';
          descEl.textContent = tab.description || '';

          const isTech = tab.key === 'tech-bites';
          const postCount = postCounts[tab.key] || 0;
          const hasPosts = postCount > 0;
          
          if (grid && placeholder && emptyMessage) {
            if (isTech && hasPosts) {
              grid.hidden = false;
              placeholder.hidden = true;
              emptyMessage.hidden = true;
            } else if (isTech && !hasPosts) {
              grid.hidden = true;
              placeholder.hidden = true;
              emptyMessage.hidden = false;
              if (emptyKey) emptyKey.textContent = tab.key || '';
            } else {
              grid.hidden = true;
              placeholder.hidden = false;
              emptyMessage.hidden = true;
            }
          }
          if (placeholderText) {
            placeholderText.textContent = tab.description || '';
          }

          if (actionBtn) {
            const label = tab.button_text || defaultLabel || tab.title || '';
            if (actionBtnLabel) actionBtnLabel.textContent = label;
            const btnUrl = tab.button_url || tab.url || '';
            actionBtn.href = resolveUrl(btnUrl);
            actionBtn.className = buildButtonClass(tab.key);
            actionBtn.hidden = !btnUrl;
          }
        }

        function step(delta) {
          idx = (idx + delta + tabs.length) % tabs.length;
          render();
        }

        prevBtn?.addEventListener('click', () => step(-1));
        nextBtn?.addEventListener('click', () => step(1));

        render();
      })();
    </script>
</section>

