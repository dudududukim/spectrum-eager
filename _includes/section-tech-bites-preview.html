{% assign section = include.section %}
{% comment %} Load sections from site.data.sections (mirrors _sections/*/config.yml) {% endcomment %}
{% assign tech_sections = '' | split: '' %}
{% if site.data.sections %}
    {% for section_pair in site.data.sections %}
        {% assign section_key = section_pair[0] %}
        {% assign section_data = section_pair[1] %}
        {% if section_data.type == 'tech-bites-preview' and section_data.enabled != false %}
            {% assign tech_sections = tech_sections | push: section_data %}
        {% endif %}
    {% endfor %}
{% endif %}
{% assign nav_tabs = tech_sections %}
{% if nav_tabs %}
    {% assign tabs_json = nav_tabs | jsonify %}
    {% assign tabs_count = nav_tabs | size %}
    {% assign default_tab = nav_tabs | first %}
{% else %}
    {% assign tabs_json = "[]" %}
    {% assign tabs_count = 0 %}
{% endif %}
{% unless default_tab %}
    {% assign default_tab = {} %}
{% endunless %}
{% assign base_label = section.button_text | default: default_tab.button_text | default: site.content.ui.buttons.view_all_tech_bites | default: "View All Tech Bites" %}
{% assign cta_url = section.button_url | default: default_tab.button_url | default: '/tech-bites/' %}
{% assign show_nav = tabs_count > 1 %}

<section class="tech-bites-preview">
    <div
        class="section-header section-header-slider"
        data-tabs="{{ tabs_json | escape }}"
        data-baseurl="{{ '' | relative_url }}"
        data-default-label="{{ base_label }}"
    >
        {% if show_nav %}
            <button class="section-nav-btn section-nav-prev" type="button" aria-label="Previous section">‹</button>
        {% endif %}
        <div class="section-header-text">
            <h2 class="section-title" id="section-tab-title">
                {{ section.title | default: site.content.pages.tech_bites.title | default: "Recent Tech Bites" }}
            </h2>
            <p class="section-description" id="section-tab-desc">
                {{ section.description | default: site.content.pages.tech_bites.description | default: "Daily tech insights and discoveries" }}
            </p>
        </div>
        {% if show_nav %}
            <button class="section-nav-btn section-nav-next" type="button" aria-label="Next section">›</button>
        {% endif %}
    </div>

    <div class="tech-bites-grid">
        {% if site.data.sections and site.data.sections.size > 0 %}
            {% assign section_key = section.key | default: "tech-bites" %}
            {% assign all_posts = site.posts | where: "section", section_key | sort: 'date' | reverse %}
            {% assign post_limit = section.main_page_count | default: 5 %}
            {% if all_posts.size > 0 %}
                {% for tech_bite in all_posts limit: post_limit %}
                    {% include tech-bite-card.html tech_bite=tech_bite %}
                {% endfor %}
            {% else %}
                <p class="empty-section-message">No posts yet. Add posts to <code>_posts/</code> folder with <code>section: "{{ section_key }}"</code> in front matter.</p>
            {% endif %}
        {% else %}
            <div class="empty-section-message">
                <p>No sections configured yet. Create <code>_sections/</code> folder and add section config files.</p>
                <p>Example: Create <code>_sections/tech-bites/config.yml</code> with section settings.</p>
            </div>
        {% endif %}
    </div>

    <div class="section-footer">
        <a href="{{ cta_url | relative_url }}" class="section-button">
            <span class="btn-label">{{ base_label }}</span>
            <span class="btn-icon">→</span>
        </a>
    </div>

    <div class="section-tab-placeholder" id="section-tab-placeholder" hidden>
        <p id="section-tab-placeholder-text" class="section-description"></p>
    </div>

    <script>
      (function() {
        const header = document.querySelector('.section-header-slider');
        if (!header) return;

        let tabs;
        try {
          tabs = JSON.parse(header.dataset.tabs || '[]');
        } catch (e) {
          tabs = [];
        }
        // Allow button to work even when tabs is empty (when _sections/ is missing)
        if (!Array.isArray(tabs)) tabs = [];

        const titleEl = document.getElementById('section-tab-title');
        const descEl = document.getElementById('section-tab-desc');
        const grid = document.querySelector('.tech-bites-grid');
        const placeholder = document.getElementById('section-tab-placeholder');
        const placeholderText = document.getElementById('section-tab-placeholder-text');
        const prevBtn = header.querySelector('.section-nav-prev');
        const nextBtn = header.querySelector('.section-nav-next');
        const actionBtn = document.querySelector('.section-footer .section-button');
        const actionBtnLabel = actionBtn?.querySelector('.btn-label');
        const baseUrl = (header.dataset.baseurl || '').replace(/\/$/, '');
        const defaultLabel = header.dataset.defaultLabel || '';

        let idx = 0;

        function resolveUrl(url) {
          if (!url) return '#';
          if (url.startsWith('http') || url.startsWith('#')) return url;
          if (url.startsWith('/')) return `${baseUrl}${url}`;
          return url;
        }

        function buildButtonClass(key) {
          const safeKey = key ? key.replace(/[^a-z0-9_-]/gi, '').toLowerCase() : 'default';
          return `section-button section-button--${safeKey}`;
        }

        function render() {
          // Handle case when tabs is empty (when _sections/ is missing)
          if (tabs.length === 0) {
            if (titleEl) titleEl.textContent = '{{ section.title | default: site.content.pages.tech_bites.title | default: "Recent Tech Bites" }}';
            if (descEl) descEl.textContent = '{{ section.description | default: site.content.pages.tech_bites.description | default: "Daily tech insights and discoveries" }}';
            if (actionBtn) {
              if (actionBtnLabel) actionBtnLabel.textContent = defaultLabel || '{{ base_label }}';
              actionBtn.href = resolveUrl('{{ cta_url }}');
              actionBtn.className = buildButtonClass('tech-bites');
              actionBtn.hidden = false;
            }
            return;
          }

          const tab = tabs[idx];
          if (!tab || !titleEl || !descEl) return;
          titleEl.textContent = tab.title || '';
          descEl.textContent = tab.description || '';

          const isTech = tab.key === 'tech-bites';
          if (grid && placeholder) {
            grid.hidden = !isTech;
            placeholder.hidden = isTech;
          }
          if (placeholderText) {
            placeholderText.textContent = tab.description || '';
          }

          if (actionBtn) {
            const label = tab.button_text || defaultLabel || tab.title || '';
            if (actionBtnLabel) actionBtnLabel.textContent = label;
            actionBtn.href = resolveUrl(tab.url || tab.button_url);
            actionBtn.className = buildButtonClass(tab.key);
            actionBtn.hidden = !tab.url && !tab.button_url;
          }
        }

        function step(delta) {
          idx = (idx + delta + tabs.length) % tabs.length;
          render();
        }

        prevBtn?.addEventListener('click', () => step(-1));
        nextBtn?.addEventListener('click', () => step(1));

        render();
      })();
    </script>
</section>

